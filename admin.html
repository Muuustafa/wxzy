<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Quiz Python</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .sidebar-hover:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-indigo-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCYjXM6YrfB862p48g6_mYX66C_La0ZsI0",
            authDomain: "quiz-python-isikm.firebaseapp.com",
            projectId: "quiz-python-isikm",
            storageBucket: "quiz-python-isikm.firebasestorage.app",
            messagingSenderId: "559369640769",
            appId: "1:559369640769:web:1ad8cb3d771f134f4d5fc0"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        const ADMIN_CREDENTIALS = {
            login: 'mustafa',
            password: '14051994'
        };

        const QUIZ_CONFIG = {
            questions: [
                // Votre liste de 50 questions reste identique
                { id: 1, code: `x = int(4.9)\nprint(x)`, question: "Quelle est la sortie ?", options: ["4.9", "4", "5", "Erreur"], correct: 1, points: 1, difficulty: "Facile" },
                // ... les 49 autres questions
            ]
        };

        function AdminDashboard() {
            const [isAuthenticated, setIsAuthenticated] = useState(() => {
                return localStorage.getItem('adminAuthenticated') === 'true';
            });
            const [loginInput, setLoginInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [results, setResults] = useState([]);
            const [activeSessions, setActiveSessions] = useState([]);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [filter, setFilter] = useState('all');
            const [classFilter, setClassFilter] = useState('all');
            const [loading, setLoading] = useState(false);
            const [showSessions, setShowSessions] = useState(false);
            const [showDetailedAnswers, setShowDetailedAnswers] = useState(false);
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [stats, setStats] = useState(null);

            // Écouter les résultats
            useEffect(() => {
                if (isAuthenticated) {
                    setLoading(true);
                    const unsubscribe = db.collection('results')
                        .orderBy('timestamp', 'desc')
                        .onSnapshot((snapshot) => {
                            const resultsData = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setResults(resultsData);
                            calculateStats(resultsData);
                            setLoading(false);
                        }, (error) => {
                            console.error('Erreur Firebase:', error);
                            setLoading(false);
                        });

                    return () => unsubscribe();
                }
            }, [isAuthenticated]);

            // Écouter les sessions actives
            useEffect(() => {
                if (isAuthenticated) {
                    const unsubscribe = db.collection('quiz_sessions')
                        .where('status', 'in', ['started'])
                        .onSnapshot((snapshot) => {
                            const sessionsData = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            setActiveSessions(sessionsData);
                        });

                    return () => unsubscribe();
                }
            }, [isAuthenticated]);

            const calculateStats = (data) => {
                if (data.length === 0) return;
                
                const notes = data.map(r => parseFloat(r.note));
                const moyenne = (notes.reduce((a, b) => a + b, 0) / notes.length).toFixed(2);
                const noteMax = Math.max(...notes).toFixed(2);
                const noteMin = Math.min(...notes).toFixed(2);
                const tauxReussite = ((data.filter(r => parseFloat(r.note) >= 10).length / data.length) * 100).toFixed(2);
                const totalTriche = data.reduce((sum, r) => sum + r.tentativesTriche, 0);

                setStats({
                    total: data.length,
                    moyenne,
                    noteMax,
                    noteMin,
                    tauxReussite,
                    totalTriche,
                    totalIAGE: data.filter(r => r.classe === 'L2-IAGE').length,
                    totalGL: data.filter(r => r.classe === 'L2-GL').length,
                    totalAdmis: data.filter(r => parseFloat(r.note) >= 10).length,
                    totalEchec: data.filter(r => parseFloat(r.note) < 10).length
                });
            };

            const handleLogin = () => {
                if (loginInput === ADMIN_CREDENTIALS.login && passwordInput === ADMIN_CREDENTIALS.password) {
                    setIsAuthenticated(true);
                    localStorage.setItem('adminAuthenticated', 'true');
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Connexion réussie',
                        text: 'Bienvenue dans le tableau de bord administrateur',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Échec de connexion',
                        text: 'Identifiant ou mot de passe incorrect',
                        confirmButtonColor: '#ef4444'
                    });
                }
            };

            const handleLogout = () => {
                Swal.fire({
                    title: 'Déconnexion',
                    text: 'Voulez-vous vraiment vous déconnecter ?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Déconnexion',
                    cancelButtonText: 'Annuler'
                }).then((result) => {
                    if (result.isConfirmed) {
                        setIsAuthenticated(false);
                        localStorage.removeItem('adminAuthenticated');
                        setResults([]);
                        setStats(null);
                    }
                });
            };

            const exportToCSV = () => {
                if (results.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'Aucune donnée',
                        text: 'Il n\'y a pas de résultats à exporter',
                        confirmButtonColor: '#3b82f6'
                    });
                    return;
                }

                const csv = [
                    ['Nom', 'Classe', 'Note/20', 'Pourcentage', 'Bonnes réponses', 'Total', 'Points', 'Max points', 'Triche', 'Pénalité', 'Date'],
                    ...results.map(r => [
                        r.etudiant,
                        r.classe,
                        r.note,
                        r.pourcentage + '%',
                        r.correct,
                        r.total,
                        r.points,
                        r.maxPoints,
                        r.tentativesTriche,
                        r.penalite,
                        r.dateTest
                    ])
                ].map(row => row.join(',')).join('\n');

                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `resultats_quiz_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();

                Swal.fire({
                    icon: 'success',
                    title: 'Export réussi',
                    text: `Les ${results.length} résultats ont été exportés`,
                    timer: 2000,
                    showConfirmButton: false
                });
            };

            const clearAllResults = () => {
                Swal.fire({
                    title: 'Confirmation',
                    html: `
                        <div class="text-center">
                            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                            <p class="text-lg font-semibold mb-2">Supprimer tous les résultats ?</p>
                            <p class="text-sm text-gray-600">Cette action est irréversible</p>
                            <p class="text-sm text-gray-600">${results.length} résultats seront supprimés</p>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Supprimer tout',
                    cancelButtonText: 'Annuler',
                    reverseButtons: true
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const batch = db.batch();
                            const snapshot = await db.collection('results').get();
                            snapshot.docs.forEach(doc => {
                                batch.delete(doc.ref);
                            });
                            await batch.commit();
                            
                            setResults([]);
                            setStats(null);
                            setSelectedStudent(null);
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Supprimé',
                                text: 'Tous les résultats ont été supprimés',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        } catch (error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Erreur',
                                text: 'Impossible de supprimer les résultats'
                            });
                        }
                    }
                });
            };

            const filterResults = () => {
                let filtered = [...results];
                
                if (filter === 'passed') filtered = filtered.filter(r => parseFloat(r.note) >= 10);
                else if (filter === 'failed') filtered = filtered.filter(r => parseFloat(r.note) < 10);
                else if (filter === 'cheating') filtered = filtered.filter(r => r.tentativesTriche > 0);
                
                if (classFilter !== 'all') {
                    filtered = filtered.filter(r => r.classe === classFilter);
                }
                
                return filtered;
            };

            const filteredResults = filterResults();

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="glass-effect rounded-2xl shadow-2xl p-8 max-w-md w-full animate-fadeIn">
                            <div className="text-center mb-8">
                                <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full mb-4">
                                    <i className="fas fa-lock text-white text-2xl"></i>
                                </div>
                                <h1 className="text-3xl font-bold gradient-text mb-2">Administration</h1>
                                <p className="text-gray-600">Tableau de bord sécurisé</p>
                            </div>

                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        <i className="fas fa-user mr-2 text-indigo-500"></i>
                                        Identifiant
                                    </label>
                                    <div className="relative">
                                        <i className="fas fa-user absolute left-3 top-3 text-gray-400"></i>
                                        <input
                                            type="text"
                                            value={loginInput}
                                            onChange={(e) => setLoginInput(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                            className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                                            placeholder="Votre identifiant"
                                        />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        <i className="fas fa-key mr-2 text-indigo-500"></i>
                                        Mot de passe
                                    </label>
                                    <div className="relative">
                                        <i className="fas fa-lock absolute left-3 top-3 text-gray-400"></i>
                                        <input
                                            type="password"
                                            value={passwordInput}
                                            onChange={(e) => setPasswordInput(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                            className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                                            placeholder="Votre mot de passe"
                                        />
                                    </div>
                                </div>

                                <button
                                    onClick={handleLogin}
                                    className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-indigo-600 hover:to-purple-700 transition-all transform hover:-translate-y-1 shadow-lg"
                                >
                                    <i className="fas fa-sign-in-alt mr-2"></i>
                                    Se connecter
                                </button>
                            </div>

                            <div className="mt-8 pt-6 border-t border-gray-200 text-center">
                                <p className="text-sm text-gray-500">
                                    <i className="fas fa-shield-alt mr-1"></i>
                                    Accès réservé aux administrateurs
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex min-h-screen bg-gray-50">
                    {/* Sidebar */}
                    <div className={`${sidebarOpen ? 'w-64' : 'w-20'} bg-gradient-to-b from-indigo-800 to-purple-900 text-white transition-all duration-300`}>
                        <div className="p-6">
                            <div className="flex items-center justify-between mb-8">
                                {sidebarOpen ? (
                                    <>
                                        <div className="flex items-center space-x-3">
                                            <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                                                <i className="fas fa-chart-line text-indigo-600 text-xl"></i>
                                            </div>
                                            <h1 className="text-xl font-bold">Dashboard</h1>
                                        </div>
                                        <button onClick={() => setSidebarOpen(false)} className="text-white hover:text-gray-300">
                                            <i className="fas fa-chevron-left"></i>
                                        </button>
                                    </>
                                ) : (
                                    <button onClick={() => setSidebarOpen(true)} className="w-full flex justify-center">
                                        <i className="fas fa-chevron-right text-xl"></i>
                                    </button>
                                )}
                            </div>

                            <nav className="space-y-2">
                                <div className={`p-3 rounded-lg flex items-center space-x-3 sidebar-hover cursor-pointer ${!showSessions ? 'bg-white bg-opacity-10' : ''}`}
                                     onClick={() => setShowSessions(false)}>
                                    <i className="fas fa-chart-bar text-lg"></i>
                                    {sidebarOpen && <span>Statistiques</span>}
                                </div>
                                
                                <div className={`p-3 rounded-lg flex items-center space-x-3 sidebar-hover cursor-pointer ${showSessions ? 'bg-white bg-opacity-10' : ''}`}
                                     onClick={() => setShowSessions(true)}>
                                    <i className="fas fa-play-circle text-lg"></i>
                                    {sidebarOpen && (
                                        <div className="flex items-center justify-between w-full">
                                            <span>Sessions actives</span>
                                            {activeSessions.length > 0 && (
                                                <span className="bg-red-500 text-white text-xs rounded-full px-2 py-1 animate-pulse">
                                                    {activeSessions.length}
                                                </span>
                                            )}
                                        </div>
                                    )}
                                </div>

                                <div className="p-3 rounded-lg flex items-center space-x-3 sidebar-hover cursor-pointer" onClick={exportToCSV}>
                                    <i className="fas fa-file-export text-lg"></i>
                                    {sidebarOpen && <span>Exporter CSV</span>}
                                </div>

                                <div className="p-3 rounded-lg flex items-center space-x-3 sidebar-hover cursor-pointer text-red-300" onClick={clearAllResults}>
                                    <i className="fas fa-trash-alt text-lg"></i>
                                    {sidebarOpen && <span>Effacer tout</span>}
                                </div>

                                <div className="p-3 rounded-lg flex items-center space-x-3 sidebar-hover cursor-pointer" onClick={handleLogout}>
                                    <i className="fas fa-sign-out-alt text-lg"></i>
                                    {sidebarOpen && <span>Déconnexion</span>}
                                </div>
                            </nav>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 overflow-x-hidden">
                        {/* Header */}
                        <header className="bg-white shadow-sm border-b">
                            <div className="px-6 py-4">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-800">
                                            <i className="fas fa-tachometer-alt mr-3 text-indigo-500"></i>
                                            Quiz Python - Administration
                                        </h2>
                                        <p className="text-gray-600 text-sm mt-1">
                                            <i className="fas fa-sync-alt mr-1 text-green-500 animate-spin"></i>
                                            {loading ? 'Synchronisation...' : 'Données en temps réel'}
                                        </p>
                                    </div>
                                    <div className="flex items-center space-x-4">
                                        <div className="bg-indigo-50 rounded-lg px-4 py-2">
                                            <div className="flex items-center space-x-2">
                                                <i className="fas fa-users text-indigo-600"></i>
                                                <span className="font-semibold text-indigo-700">{results.length}</span>
                                                <span className="text-gray-600">étudiants</span>
                                            </div>
                                        </div>
                                        <div className="text-sm text-gray-500">
                                            <i className="far fa-clock mr-1"></i>
                                            {new Date().toLocaleTimeString('fr-FR')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </header>

                        <main className="p-6">
                            {/* Sessions actives */}
                            {showSessions && activeSessions.length > 0 && (
                                <div className="mb-6 animate-fadeIn">
                                    <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl shadow-lg p-6 border border-green-200">
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="flex items-center space-x-3">
                                                <div className="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                                    <i className="fas fa-play-circle text-2xl text-green-600"></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-xl font-bold text-gray-800">Quiz en cours</h3>
                                                    <p className="text-gray-600">{activeSessions.length} session(s) active(s)</p>
                                                </div>
                                            </div>
                                            <span className="flex items-center space-x-2">
                                                <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                                <span className="text-sm font-semibold text-green-600">EN DIRECT</span>
                                            </span>
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {activeSessions.map(session => (
                                                <div key={session.id} className="bg-white rounded-lg border-2 border-green-200 p-4 hover:shadow-md transition">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <h4 className="font-bold text-gray-800">{session.etudiant}</h4>
                                                            <p className="text-sm text-gray-600">
                                                                <i className="fas fa-graduation-cap mr-1"></i>
                                                                {session.classe}
                                                            </p>
                                                        </div>
                                                        {session.tabSwitches > 0 && (
                                                            <span className="bg-red-100 text-red-800 text-xs font-semibold px-2 py-1 rounded-full">
                                                                <i className="fas fa-exclamation-triangle mr-1"></i>
                                                                {session.tabSwitches}
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center justify-between text-sm">
                                                        <span className="text-gray-600">
                                                            <i className="far fa-question-circle mr-1"></i>
                                                            Question {session.currentQuestion || 0}/50
                                                        </span>
                                                        <span className="text-indigo-600 font-semibold">
                                                            <i className="far fa-clock mr-1"></i>
                                                            {session.startTime ? 'En cours' : 'Début imminent'}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Statistiques */}
                            {!showSessions && stats && (
                                <div className="mb-6 animate-fadeIn">
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                        <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-200 hover:shadow-xl transition">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                                    <i className="fas fa-users text-2xl text-blue-600"></i>
                                                </div>
                                                <span className="text-2xl font-bold text-blue-600">{stats.total}</span>
                                            </div>
                                            <h3 className="text-lg font-semibold text-gray-800 mb-2">Total étudiants</h3>
                                            <p className="text-gray-600 text-sm">Tous les participants au quiz</p>
                                        </div>

                                        <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-200 hover:shadow-xl transition">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                                    <i className="fas fa-chart-line text-2xl text-green-600"></i>
                                                </div>
                                                <span className="text-2xl font-bold text-green-600">{stats.moyenne}/20</span>
                                            </div>
                                            <h3 className="text-lg font-semibold text-gray-800 mb-2">Moyenne générale</h3>
                                            <p className="text-gray-600 text-sm">Score moyen des étudiants</p>
                                        </div>

                                        <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-200 hover:shadow-xl transition">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                                    <i className="fas fa-trophy text-2xl text-purple-600"></i>
                                                </div>
                                                <span className="text-2xl font-bold text-purple-600">{stats.tauxReussite}%</span>
                                            </div>
                                            <h3 className="text-lg font-semibold text-gray-800 mb-2">Taux de réussite</h3>
                                            <p className="text-gray-600 text-sm">{stats.totalAdmis} admis sur {stats.total}</p>
                                        </div>

                                        <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-200 hover:shadow-xl transition">
                                            <div className="flex items-center justify-between mb-4">
                                                <div className="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                                                    <i className="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                                                </div>
                                                <span className="text-2xl font-bold text-red-600">{stats.totalTriche}</span>
                                            </div>
                                            <h3 className="text-lg font-semibold text-gray-800 mb-2">Tentatives de triche</h3>
                                            <p className="text-gray-600 text-sm">Changements d'onglet détectés</p>
                                        </div>
                                    </div>

                                    {/* Détails statistiques */}
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6">
                                            <h4 className="font-bold text-gray-800 mb-4 flex items-center">
                                                <i className="fas fa-user-graduate mr-2 text-blue-600"></i>
                                                Répartition par classe
                                            </h4>
                                            <div className="space-y-3">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-gray-600">L2-IAGE</span>
                                                    <span className="font-bold text-blue-600">{stats.totalIAGE}</span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span className="text-gray-600">L2-GL</span>
                                                    <span className="font-bold text-teal-600">{stats.totalGL}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6">
                                            <h4 className="font-bold text-gray-800 mb-4 flex items-center">
                                                <i className="fas fa-chart-pie mr-2 text-green-600"></i>
                                                Résultats
                                            </h4>
                                            <div className="space-y-3">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-gray-600">Admis</span>
                                                    <span className="font-bold text-green-600">{stats.totalAdmis}</span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span className="text-gray-600">Échec</span>
                                                    <span className="font-bold text-red-600">{stats.totalEchec}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6">
                                            <h4 className="font-bold text-gray-800 mb-4 flex items-center">
                                                <i className="fas fa-star mr-2 text-purple-600"></i>
                                                Performances
                                            </h4>
                                            <div className="space-y-3">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-gray-600">Note maximale</span>
                                                    <span className="font-bold text-purple-600">{stats.noteMax}/20</span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span className="text-gray-600">Note minimale</span>
                                                    <span className="font-bold text-orange-600">{stats.noteMin}/20</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Filtres */}
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6 animate-fadeIn">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                                    <div>
                                        <h3 className="text-xl font-bold text-gray-800 mb-2">Filtrer les résultats</h3>
                                        <p className="text-gray-600">Affinez l'affichage selon vos critères</p>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <span className="text-sm text-gray-500">{filteredResults.length} résultat(s)</span>
                                        <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    <div>
                                        <h4 className="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                            <i className="fas fa-filter mr-2 text-indigo-500"></i>
                                            Par statut
                                        </h4>
                                        <div className="flex flex-wrap gap-2">
                                            <button onClick={() => setFilter('all')} 
                                                    className={`px-4 py-2 rounded-lg font-medium transition-all ${filter === 'all' ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                Tous ({results.length})
                                            </button>
                                            <button onClick={() => setFilter('passed')} 
                                                    className={`px-4 py-2 rounded-lg font-medium transition-all ${filter === 'passed' ? 'bg-green-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                <i className="fas fa-check-circle mr-1"></i>
                                                Admis ({results.filter(r => parseFloat(r.note) >= 10).length})
                                            </button>
                                            <button onClick={() => setFilter('failed')} 
                                                    className={`px-4 py-2 rounded-lg font-medium transition-all ${filter === 'failed' ? 'bg-red-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                <i className="fas fa-times-circle mr-1"></i>
                                                Échec ({results.filter(r => parseFloat(r.note) < 10).length})
                                            </button>
                                            <button onClick={() => setFilter('cheating')} 
                                                    className={`px-4 py-2 rounded-lg font-medium transition-all ${filter === 'cheating' ? 'bg-orange-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                <i className="fas fa-exclamation-triangle mr-1"></i>
                                                Triche ({results.filter(r => r.tentativesTriche > 0).length})
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <h4 className="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                                            <i className="fas fa-graduation-cap mr-2 text-indigo-500"></i>
                                            Par classe
                                        </h4>
                                        <div className="flex flex-wrap gap-2">
                                            <button onClick={() => setClassFilter('all')} 
                                                    className={`px-4 py-2 rounded-lg font-medium transition-all ${classFilter === 'all' ? 'bg-purple-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                Toutes ({results.length})
                                            </button>
                                            <button onClick={() => setClassFilter('L2-IAGE')} 
                                                    className={`px-4 py-2 rounded-lg font-medium transition-all ${classFilter === 'L2-IAGE' ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                L2-IAGE ({results.filter(r => r.classe === 'L2-IAGE').length})
                                            </button>
                                            <button onClick={() => setClassFilter('L2-GL')} 
                                                    className={`px-4 py-2 rounded-lg font-medium transition-all ${classFilter === 'L2-GL' ? 'bg-teal-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>
                                                L2-GL ({results.filter(r => r.classe === 'L2-GL').length})
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Tableau des résultats */}
                            <div className="bg-white rounded-xl shadow-lg overflow-hidden animate-fadeIn">
                                <div className="px-6 py-4 border-b border-gray-200">
                                    <div className="flex items-center justify-between">
                                        <h3 className="text-xl font-bold text-gray-800">Résultats détaillés</h3>
                                        <div className="flex items-center space-x-2">
                                            <button onClick={exportToCSV} 
                                                    className="px-4 py-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all flex items-center">
                                                <i className="fas fa-download mr-2"></i>
                                                Exporter
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {filteredResults.length === 0 ? (
                                    <div className="text-center py-12">
                                        <i className="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                                        <p className="text-gray-500 text-lg">Aucun résultat à afficher</p>
                                        <p className="text-gray-400 text-sm mt-1">Les résultats apparaîtront ici</p>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        <i className="fas fa-user mr-1"></i>
                                                        Étudiant
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        <i className="fas fa-graduation-cap mr-1"></i>
                                                        Classe
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        <i className="fas fa-star mr-1"></i>
                                                        Note
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        <i className="fas fa-chart-bar mr-1"></i>
                                                        Performance
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        <i className="fas fa-shield-alt mr-1"></i>
                                                        Surveillance
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        <i className="fas fa-calendar mr-1"></i>
                                                        Date
                                                    </th>
                                                    <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                                        <i className="fas fa-cog mr-1"></i>
                                                        Actions
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {filteredResults.map((result, index) => (
                                                    <tr key={index} className="hover:bg-gray-50 transition">
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            <div className="flex items-center">
                                                                <div className="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center mr-3">
                                                                    <i className="fas fa-user text-indigo-600 text-sm"></i>
                                                                </div>
                                                                <div>
                                                                    <div className="text-sm font-medium text-gray-900">{result.etudiant}</div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            <span className={`px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${result.classe === 'L2-IAGE' ? 'bg-blue-100 text-blue-800' : 'bg-teal-100 text-teal-800'}`}>
                                                                {result.classe}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            <div className={`text-xl font-bold ${parseFloat(result.note) >= 10 ? 'text-green-600' : 'text-red-600'}`}>
                                                                {result.note}/20
                                                            </div>
                                                            <div className="text-xs text-gray-500">{result.correct}/{result.total} bonnes</div>
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            <div className="flex items-center">
                                                                <div className="flex-1">
                                                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                                                        <div className="bg-gradient-to-r from-green-400 to-green-600 h-2 rounded-full" 
                                                                             style={{ width: `${result.pourcentage}%` }}></div>
                                                                    </div>
                                                                    <div className="text-xs text-gray-600 mt-1">{result.pourcentage}%</div>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap">
                                                            {result.tentativesTriche > 0 ? (
                                                                <div className="flex items-center text-red-600">
                                                                    <i className="fas fa-exclamation-triangle mr-2"></i>
                                                                    <span className="font-semibold">{result.tentativesTriche} tentative(s)</span>
                                                                </div>
                                                            ) : (
                                                                <span className="text-green-600">
                                                                    <i className="fas fa-check-circle"></i>
                                                                    <span className="ml-1">Aucune</span>
                                                                </span>
                                                            )}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                            <i className="far fa-clock mr-1"></i>
                                                            {result.dateTest}
                                                        </td>
                                                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                                                            <button onClick={() => setSelectedStudent(result)} 
                                                                    className="text-indigo-600 hover:text-indigo-900 font-medium flex items-center">
                                                                <i className="fas fa-eye mr-1"></i>
                                                                Détails
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>

                    {/* Modal Détails Étudiant */}
                    {selectedStudent && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-fadeIn">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                                {/* Header du modal */}
                                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <h2 className="text-2xl font-bold">{selectedStudent.etudiant}</h2>
                                            <p className="text-indigo-100">{selectedStudent.classe}</p>
                                        </div>
                                        <button onClick={() => setSelectedStudent(null)} className="text-white hover:text-gray-200 text-2xl">
                                            <i className="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>

                                {/* Contenu du modal */}
                                <div className="p-6 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 140px)' }}>
                                    {/* Score principal */}
                                    <div className="text-center mb-8">
                                        <div className={`inline-flex items-center justify-center w-24 h-24 ${parseFloat(selectedStudent.note) >= 10 ? 'bg-green-100' : 'bg-red-100'} rounded-full mb-4`}>
                                            <span className={`text-4xl font-bold ${parseFloat(selectedStudent.note) >= 10 ? 'text-green-600' : 'text-red-600'}`}>
                                                {selectedStudent.note}
                                            </span>
                                            <span className={`text-xl ${parseFloat(selectedStudent.note) >= 10 ? 'text-green-600' : 'text-red-600'}`}>/20</span>
                                        </div>
                                        <h3 className="text-2xl font-bold text-gray-800 mb-2">Résultat final</h3>
                                        <p className="text-gray-600">{selectedStudent.correct} réponses correctes sur {selectedStudent.total}</p>
                                    </div>

                                    {/* Stats rapides */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                        <div className="bg-blue-50 p-4 rounded-lg text-center">
                                            <div className="text-2xl font-bold text-blue-600 mb-1">{selectedStudent.pourcentage}%</div>
                                            <div className="text-sm text-gray-600">Réussite</div>
                                        </div>
                                        <div className="bg-green-50 p-4 rounded-lg text-center">
                                            <div className="text-2xl font-bold text-green-600 mb-1">{selectedStudent.correct}</div>
                                            <div className="text-sm text-gray-600">Correctes</div>
                                        </div>
                                        <div className="bg-purple-50 p-4 rounded-lg text-center">
                                            <div className="text-2xl font-bold text-purple-600 mb-1">{selectedStudent.duree}</div>
                                            <div className="text-sm text-gray-600">Durée</div>
                                        </div>
                                        <div className="bg-red-50 p-4 rounded-lg text-center">
                                            <div className="text-2xl font-bold text-red-600 mb-1">{selectedStudent.tentativesTriche}</div>
                                            <div className="text-sm text-gray-600">Triches</div>
                                        </div>
                                    </div>

                                    {/* Détails des réponses */}
                                    {showDetailedAnswers && selectedStudent.detailsReponses && (
                                        <div className="space-y-6">
                                            <h4 className="text-xl font-bold text-gray-800 mb-4">Détails des réponses</h4>
                                            {/* Les sections de détails restent identiques */}
                                        </div>
                                    )}

                                    {/* Actions */}
                                    <div className="flex flex-col sm:flex-row gap-3 mt-8">
                                        <button onClick={() => setShowDetailedAnswers(!showDetailedAnswers)} 
                                                className="flex-1 bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-indigo-600 hover:to-purple-700 transition-all flex items-center justify-center">
                                            <i className="fas fa-chart-bar mr-2"></i>
                                            {showDetailedAnswers ? 'Masquer les détails' : 'Voir les détails'}
                                        </button>
                                        <button onClick={() => {
                                            // Exporter le rapport
                                            const report = `Rapport détaillé - ${selectedStudent.etudiant}\n\n`;
                                            const blob = new Blob([report], { type: 'text/plain' });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = `rapport_${selectedStudent.etudiant}.txt`;
                                            a.click();
                                        }} 
                                                className="flex-1 bg-gradient-to-r from-blue-500 to-cyan-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-cyan-700 transition-all flex items-center justify-center">
                                            <i className="fas fa-file-export mr-2"></i>
                                            Exporter rapport
                                        </button>
                                        <button onClick={() => setSelectedStudent(null)} 
                                                className="px-6 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-all">
                                            Fermer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminDashboard />);
    </script>
</body>
</html>
